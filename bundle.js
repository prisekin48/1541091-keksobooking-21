(()=>{"use strict";window.util={getRandomElementFromArray:e=>e[window.util.getRandomNumber(0,e.length-1)],getRandomArray:e=>{const t=[],n=window.util.getRandomNumber(1,e.length),o=e.slice();for(let e=0;e<n;e++){const e=window.util.getRandomNumber(0,o.length-1);t.push(o.splice(e,1)[0])}return t},getRandomNumber:(e,t)=>(e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e)},(()=>{const e=document.querySelector(".map"),t=e.querySelectorAll(".map__filter"),n=e.querySelector(".map__features"),o=e=>{for(const n of t)n.disabled=!e;n.disabled=!e};window.map={switchState:t=>{t?(e.classList.remove("map--faded"),window.backend.makeRequest()):(e.classList.add("map--faded"),(()=>{const t=e.querySelectorAll(".map__pin:not(.map__pin--main)");for(const e of t)e.remove()})(),o(t))},renderPins:t=>{const n=document.createDocumentFragment(),r=e.querySelector(".map__pins");t.forEach((e=>{const t=window.pin.create(e);n.appendChild(t)})),r.appendChild(n),o(!0)}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=e=>{e.classList.add("map__pin--active")};window.pin={create:n=>{const o=e.cloneNode(!0),r=o.querySelector("img");return o.style.left=n.location.x-25+"px",o.style.top=n.location.y-70+"px",r.src=""+n.author.avatar,r.alt=""+n.offer.title,o.addEventListener("keydown",(e=>{((e,n,o)=>{"Enter"===e.key&&(window.card.removeCurrent(),window.card.render(n),t(o))})(e,n,o)})),o.addEventListener("click",(()=>{var e,r;e=n,r=o,window.card.removeCurrent(),window.card.render(e),t(r)})),o},unsetActive:()=>{const e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")}}})(),(()=>{const e={MIN_TITLE_LENGHT:30,MAX_TITLE_LENGHT:100,MIN_PRICE:{palace:1e4,flat:1e3,house:5e3,bungalow:0},MAX_PRICE:1e6},t={0:{disabled:[0,1,3],enabled:[2]},1:{disabled:[0,3],enabled:[1,2]},2:{disabled:[3],enabled:[0,1,2]},3:{disabled:[0,1,2],enabled:[3]}},n=document.querySelector(".ad-form"),o=n.querySelectorAll("fieldset"),r=n.querySelector("#title"),d=n.querySelector("#price"),i=n.querySelector("#type"),a=n.querySelector("#timein"),c=n.querySelector("#timeout"),s=n.querySelector("#room_number"),l=n.querySelector("#capacity"),u=e=>{e.validity.valid?e.style.border="unset":e.style.border="2px solid #f00"},m=e=>{e.target===a&&(c.options.selectedIndex=e.target.options.selectedIndex),e.target===c&&(a.options.selectedIndex=e.target.options.selectedIndex)},p=()=>{let t=`Диапазон цен для выбранного типа жилья:\n\n                        ${e.MIN_PRICE[i.value]} - ${e.MAX_PRICE}`;d.value<e.MIN_PRICE[i.value]||d.value>e.MAX_PRICE?d.setCustomValidity(t):d.setCustomValidity(""),u(d),d.reportValidity()},f=()=>{d.placeholder=e.MIN_PRICE[i.value],d.min=e.MIN_PRICE[i.value],d.max=e.MAX_PRICE},w=e=>{e.preventDefault(),window.card.removeCurrent();let t=new FormData(n);window.backend.submitForm(t)};r.addEventListener("input",(()=>{let t=`Заголовок объявления должен содержать от\n                            ${e.MIN_TITLE_LENGHT} до ${e.MAX_TITLE_LENGHT} символов.\n                            \nВы ввели ${r.value.length}.`;r.value.length<e.MIN_TITLE_LENGHT||r.value.length>e.MAX_TITLE_LENGHT?r.setCustomValidity(t):r.setCustomValidity(""),u(r),r.reportValidity()})),d.addEventListener("input",(()=>{p()})),a.addEventListener("change",(e=>{m(e)})),c.addEventListener("change",(e=>{m(e)})),i.addEventListener("change",(()=>{f(),p()})),s.addEventListener("change",(()=>{const e=s.options.selectedIndex;l.options.selectedIndex=t[e].enabled[0],(()=>{const e=s.options.selectedIndex;for(let n of t[e].disabled)l.options[n].disabled=!0;for(let n of t[e].enabled)l.options[n].disabled=!1})()})),n.addEventListener("submit",w),f(),window.form={enable:()=>{n.classList.remove("ad-form--disabled");for(const e of o)e.disabled=!1},disable:()=>{n.reset(),document.querySelector(".ad-form__photo").innerHTML="",document.querySelector(".ad-form-header__preview img").src="img/muffin-grey.svg",n.classList.add("ad-form--disabled");for(const e of o)e.disabled=!0;f()},submit:w}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector("#address"),n={MIN_Y:130,MAX_Y:630,MIN_X:0,MAX_X:1200},o=(e,n,o)=>{e?t.setAttribute("value",`${n+32}, ${o+87}`):t.setAttribute("value",`${n+32}, ${o+32}`)};let r={};const d=t=>{let d=r.x-t.clientX,i=r.y-t.clientY;r.x=t.clientX,r.y=t.clientY,t.clientY>=n.MIN_Y-87-c.y&&t.clientY<=n.MAX_Y-87-c.y&&t.clientX>=n.MIN_X-32-c.x&&t.clientX<=n.MAX_X-32-c.x&&(e.style.top=e.offsetTop-i+"px",e.style.left=e.offsetLeft-d+"px"),o(window.main.isActive,e.offsetLeft,e.offsetTop)},i=()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",i)},a=e=>{"Enter"===e.key&&(e.preventDefault(),window.main.activate())};let c={};const s=t=>{0===t.button&&(r.x=t.clientX,r.y=t.clientY,c.x=e.offsetLeft-r.x,c.y=e.offsetTop-r.y,document.addEventListener("mousemove",d),document.addEventListener("mouseup",i))},l=()=>{window.main.activate(),e.removeEventListener("keydown",a),e.removeEventListener("click",l)};window.mainPin={reset:()=>{e.style.left="570px",e.style.top="375px",o(window.main.isActive,e.offsetLeft,e.offsetTop)},setAddress:o,WorkingArea:n,addMainPinListeners:()=>{e.addEventListener("click",l),e.addEventListener("mousedown",s),e.addEventListener("keydown",a)}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.querySelector(".map__filters-container"),n={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},o=(e,t)=>{e?t.textContent=e:t.remove()},r=e=>{"Escape"===e.key&&d()},d=()=>{const e=document.querySelector(".map__card");e&&e.remove(),window.pin.unsetActive(),document.removeEventListener("keydown",r)};window.card={render:i=>{const a=e.cloneNode(!0),c=a.querySelector(".popup__close");o(i.offer.title,a.querySelector(".popup__title")),o(i.offer.address,a.querySelector(".popup__text--address")),o(i.offer.price+"₽/ночь",a.querySelector(".popup__text--price")),o(n[i.offer.type],a.querySelector(".popup__type")),o(`${i.offer.rooms} комнаты для ${i.offer.guests} гостей`,a.querySelector(".popup__text--capacity")),o(`Заезд после ${i.offer.checkin}, выезд до ${i.offer.checkout}`,a.querySelector(".popup__text--time")),((e,t)=>{const n=e.querySelector(".popup__feature");if(e.innerHTML="",t.length>0){let o=document.createDocumentFragment();for(let e of t){let t=n.cloneNode();t.classList.value="popup__feature popup__feature--"+e,t.textContent=e,o.appendChild(t)}e.appendChild(o)}})(a.querySelector(".popup__features"),i.offer.features),o(i.offer.description,a.querySelector(".popup__description")),((e,t)=>{const n=e.querySelector(".popup__photo");if(e.innerHTML="",t.length>0){let o=document.createDocumentFragment();for(let e of t){let t=n.cloneNode();t.src=e,o.appendChild(t)}e.appendChild(o)}})(a.querySelector(".popup__photos"),i.offer.photos),a.querySelector(".popup__avatar").src=i.author.avatar,c.addEventListener("click",(()=>{d()})),c.addEventListener("keydown",(e=>{"Enter"===e.key&&d()})),document.addEventListener("keydown",r),t.before(a)},removeCurrent:d}})(),(()=>{window.ADS_COUNT=5;const e=document.querySelector(".map"),t=document.querySelector(".ad-form__submit"),n=(t,n)=>{const o=document.createElement("div");o.style.position="absolute",o.style.maxWidth="20%",o.style.top="20px",o.style.left="20px",o.style.padding="10px",o.style.backgroundColor=n?"crimson":"lightgreen",o.textContent=t,o.addEventListener("click",(()=>{o.remove()})),e.appendChild(o),setTimeout((()=>{o&&o.remove()}),5e3)},o=(e,t,n)=>{e.timeout=1e4,e.addEventListener("load",(()=>{let o;switch(e.status){case 200:t(e.response);break;case 400:o="Неверный запрос";break;case 401:o="Пользователь не авторизован";break;case 404:o="Ничего не найдено";break;default:o=`Статус ответа: ${e.status} ${e.statusText}`}o&&n(o)})),e.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${e.timeout} мс`)}))},r=e=>{window.backend.ads=e,window.map.renderPins(window.backend.ads.slice(null,window.ADS_COUNT)),n("Объявления загружены успешно",!1)},d=e=>{n("При загрузке объявлений произошла ошибка: "+e,!0)},i=e=>{e.preventDefault(),"Escape"===e.key&&(c.remove(),document.removeEventListener("keydown",i),document.removeEventListener("click",a))},a=e=>{e.preventDefault(),c.remove(),document.removeEventListener("keydown",i),document.removeEventListener("click",a)};let c=document.createDocumentFragment();const s=e=>{e?c=document.querySelector("#success").content.querySelector(".success").cloneNode(!0):(c=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),c.querySelector(".error__button").addEventListener("click",(e=>{c.remove(),window.form.submit(e)}))),document.querySelector("main").appendChild(c),t.blur(),document.addEventListener("keydown",i),document.addEventListener("click",a)},l=()=>{window.main.deactivate(),s(!0)},u=()=>{s(!1)};window.backend={makeRequest:()=>{((e,t)=>{const n=new XMLHttpRequest;n.responseType="json",o(n,e,t),n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()})(r,d)},submitForm:e=>{((e,t,n)=>{const r=new XMLHttpRequest;o(r,t,n),r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(e)})(e,l,u)}}})(),(()=>{const e="any",t=document.querySelectorAll(".map__checkbox"),n=document.querySelector(".map__filters"),o=n.querySelector("#housing-type"),r=n.querySelector("#housing-price"),d=n.querySelector("#housing-rooms"),i=n.querySelector("#housing-guests"),a=n.querySelector("#filter-wifi"),c=n.querySelector("#filter-dishwasher"),s=n.querySelector("#filter-parking"),l=n.querySelector("#filter-washer"),u=n.querySelector("#filter-elevator"),m=n.querySelector("#filter-conditioner");window.lastTimeout=null;const p=()=>{window.lastTimeout&&window.clearTimeout(window.lastTimeout),window.lastTimeout=window.setTimeout((()=>{var e;e=f(),window.card.removeCurrent(),document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.remove())),window.map.renderPins(e)}),500)},f=()=>{const n=window.backend.ads;let a=[];for(let s=0;s<n.length&&(!((t=>o.value===e||t.offer.type===o.value)(c=n[s])&&(t=>{switch(r.value){case e:return!0;case"low":return t.offer.price<=9999;case"high":return t.offer.price>=50001;case"middle":return t.offer.price>9999&&t.offer.price<50001;default:return!1}})(c)&&(t=>d.value===e||t.offer.rooms===parseInt(d.value,10))(c)&&(t=>i.value===e||t.offer.guests===parseInt(i.value,10))(c)&&(e=>{let n=[];t.forEach((e=>{e.checked&&n.push(e.value)}));for(let t of n)if(!1===e.offer.features.includes(t))return!1;return!0})(c))||(a.push(n[s]),a.length!==window.ADS_COUNT));s++);var c;return a};o.addEventListener("change",p),r.addEventListener("change",p),d.addEventListener("change",p),i.addEventListener("change",p),a.addEventListener("change",p),c.addEventListener("change",p),s.addEventListener("change",p),l.addEventListener("change",p),u.addEventListener("change",p),m.addEventListener("change",p),window.filters={reset:()=>{o.selectedIndex=0,r.selectedIndex=0,d.selectedIndex=0,i.selectedIndex=0,a.checked=!1,c.checked=!1,s.checked=!1,l.checked=!1,u.checked=!1,m.checked=!1}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".ad-form__reset"),n=()=>{window.main.isActive=!1,window.map.switchState(window.main.isActive),window.filters.reset(),window.mainPin.addMainPinListeners(),window.mainPin.reset(),window.form.disable()};window.main={isActive:!1,activate:()=>{window.main.isActive=!0,window.map.switchState(window.main.isActive),window.mainPin.setAddress(window.main.isActive,e.offsetLeft,e.offsetTop),window.form.enable()},deactivate:n},t.addEventListener("click",(()=>{window.main.deactivate()})),n()})(),(()=>{const e=["image/jpg","image/jpeg","image/png"],t=document.querySelector("#avatar"),n=document.querySelector(".ad-form-header__preview img"),o=document.querySelector("#images"),r=document.querySelector(".ad-form__photo"),d=e=>{n.src=e},i=e=>{let t=document.createElement("img");t.style.width="70px",t.style.height="70px",t.src=e,r.innerHTML="",r.append(t)},a=(t,n)=>{const o=t.files[0];let r=!1;if(o&&(r=e.some((e=>o.type===e))),r){const e=new FileReader;e.addEventListener("load",(()=>{n(e.result)})),e.readAsDataURL(o)}};t.addEventListener("change",(()=>{a(t,d)})),o.addEventListener("change",(()=>{a(o,i)}))})()})();